---
layout: post
title: "좌충우돌 레디스 활용 기"
comments: true
description: ""
keywords: ""
---


## 배경


입사한지 어느덧 1년이 조금 지난 유사개발자는 놀랍게도 

직접 개발하고 운영및 서비스중인 API 서버 하나를 제외하고 어떤 서버도 두고 있지 않다! 두둥탁!

그러던 어느날 평화롭게 회식을 하던 유사개발자는 겁나 무시무시한 TTS 장애 티켓을 받게 되었다!!

그로 인해 배치서버의 필요성과 캐싱이 필요하다는것을 인지하게 되었는데...!


## 문제 발견

우선 푸시만을 위한 무언가가 필요하다.

이전에는 다른 팀에서 구성해논 푸시 프록시 서버로 콜을 날리고 있었는데

문제는 1대1 푸시였기 때문에 100명에 유저에게 푸시를 보내려면 100번 호출 해야 했다!!!

예를 들면, 카카오톡 단톡방 푸시를 생각해보면 50명이 있는 단톡방에 한명이 톡을 보냈을때
나를 제외한 49명에게 푸시를 보내기 위해 49번을 호출해야 했다.

하지만 일반적으로 단톡방은 쉬지않고 카톡이 올라오기 때문에 49번 x 카톡 수 만큼 요청을 하게된다.

이 부하를 견디기엔 작고 소중한 내 API 서버는 너무나 연약했다.


더이상의 서버장애는 모 야메룽다!!!


## 문제 해결 전략

푸시만을 위한 서버를 따로두어 부하를 분산시켜야 한다.

푸시 서버를 나누게 된다면 푸시서버에 부하가 생기면 푸시서버 팟 또는 워커 노드를 늘리면 된다. 

즉, 스케일링에 용이하다.


푸시 서버는 결국 들어오는 요청 순서대로 푸시 요청을 처리 역할을 하게 된다.

여기서 "들어오는 요청 순서대로 처리" 라는 문구가 어디서 많이 봤던거였다.

결국엔 자료구조 수업중에 첫시간에 배우는 큐(Queue) 를 사용한다.

큐에 푸시 요청 콜을 담아서 배치 서버가 푸시 요청이 들어오면 푸시를 보낸다.

> 용어가 부정확할 수 있는데 결국 배치 서버이자 푸시 서버가 되었다.


#### 중간정리

1. 푸시 부하를 전담할 서버가 필요하다.
2. 큐를 사용해 만들겠다.

작고 연약한 API 서버가 provider가 되고 배치 서버가 consumer가 되겠다.


### 구현

메세지 큐를 사용한다고 했을때 내가 선택할 수 있는 선택지들이 생겨난다.

1. Kafka / Pub - Sub 구조에 특화돤 분산 큐
2. 아마존 SQS / 클라우드 짱짱
3. RabitMQ / 얼랭기반으로 높은 신뢰성과 많은 레퍼런스들
4. Redis / 인메모리 키밸류 스토어


큐를 사용하기 위해 여러가지 방법이 있지만 제일 무난하다고 생각이 드는(만만하게 느껴진다라는 뜻) 레디스를 선택했다.
그리고 어차피 레디스로 캐싱도 구현해야 했다...


레디스로 BRPUSH, BLPOP 을 써서 큐를 구현하려고 했는데

Bee-Queue라는 므찐 라이브러리를 추천받아 사용하게 되었다.

> 배치서버는 나름 힙하고 타입에 익숙해지기 위해서 TS를 사용하게 되었는데, 생각보다 불편하다 ㅎㅎㅎㅎㅎ

암튼 테스트는 **싱글 인스턴스**로 구성된 레디스 망에다가 테스트했는데

라이브망은 **클러스터**로 구성되어 있기 때문에 오류가 났따!!!!!

클러스터로 구성되어 있기 때문에 키가 여러곳에 분산 저장되어있기 때문인데

프리픽스를 {} 로 감싸주면 간단하게 해결된다

https://redis.io/topics/cluster-spec

여기 보면 자세히 나옴ㅎ


이 다음은 다음에~~난 이제 퇴근한다구~~~
