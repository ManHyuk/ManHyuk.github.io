---
layout: post
title: "좌충우돌 레디스 활용 기"
comments: true
description: ""
keywords: ""
---


## 서론


입사한지 어느덧 1년이 조금 지난 유사개발자는 놀랍게도 

직접 개발하고 운영및 서비스중인 API 서버에 단 한대의 캐싱 서버도 두고 있지 않다! 두둥탁!

그러던 어느날 평화롭게 회식을 하던 유사개발자는 겁나 무시무시한 TTS 장애 티켓을 받게 되었다!!

그로 인해 배치서버의 필요성과 캐싱이 필요하다는것을 인지하게 되었는데...!


## 본론

우선 푸시를 보내기 위한 배치 서버가 필요하다.
이전에는 다른 팀에서 구성해논 푸시 프록시 서버로 콜을 날리고 있었는데

문제는 1대1 푸시였기 때문에 100명에 유저에게 푸시를 보내려면 100번 호출 해야 했따!!!

비동기로 백그라운드에서 콜하게 해뒀으니 괜찮겠지 했는데

모 야메룽다!!!

100명에게 콜날리는 경우가 빈번해지기 시작하면 아무리 백그라운드에서 콜을 한다고 해도 무리가 생긴다

즉 푸시서버를 따로두어 부하를 분산시켜야 한다.

그리고 푸시 서버를 나누게 된다면 푸시서버에 부하가 생기면 푸시서버 팟 또는 워커 노드를 늘리면 된다 (쿠버네티스 사용중)

푸시 서버를 만들까 했더니 결국엔 다른 기능에서도 문제가 있는것 같아

푸시를 위한 서버가아닌 공용으로 사용할 배치 서버를 만들기로 했다.

큐를 만들어 큐에 들어오는 순서대로 푸시를 보내는 용도로 서버를 구성하기로 했다

큐를 사용하기 위해 여러가지 방법이 있지만 제일 무난하고 어차피 레디스를 붙여서 캐시로도 사용해야 했기 때문에

레디스로 BRPUSH, BLPOP 을 써서 큐를 구현하려고 했는데

Bee-Queue라는 므찐 라이브러리를 추천받아 사용하게 되었다.

배치서버는 나름 힙하고 타입에 익숙해지기 위해서 TS를 사용하게 되었는데, 생각보다 불편하다 ㅎㅎㅎㅎㅎ

암튼 테스트는 **싱글 인스턴스**로 구성된 레디스 망에다가 테스트했는데

라이브망은 **클러스터**로 구성되어 있기 때문에 오류가 났따!!!!!

클러스터로 구성되어 있기 때문에 키가 여러곳에 분산 저장되어있기 때문인데

프리픽스로 {} 를 감싸주면 간단하게 해결된다

https://redis.io/topics/cluster-spec

여기 보면 자세히 나옴ㅎ


이 다음은 다음에~~난 이제 퇴근한다구~~~
