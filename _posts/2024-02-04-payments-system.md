---
layout: post
title: "11장 결제 시스템"
comments: true
description: ""
keywords: ""
---



## 기능 요구사항
- 대금 수신 흐름
- 대금 정산 흐름

## 비기능 요구사항
- 신뢰성 및 내결함성
- 내부/외부 서비스 간의 조정 프로세스

## 대략적인 규모 추정
- 하루 100만건의 결제요청 -> 1,000,000 / 10^5초 = 초당 10건의 트랜젹선 = 10TPS



### 대금 수신 및 정산 흐름

![pay-overview](/images/payment-system/pg-overview.png)
구매자 -> 신용카드 -> (대금 수신) -> 은행계좌 -> (대금 정산) -> 은행계좌 -> 판매자


### 용어 정리 

#### 결제 서비스
결제 서비스는 사용자로부터 결제 이벤트를 수락하고 결제 프로세스를 조율한다.
이때 범죄 행위등을 평가하는 위험 점검후 통과한 결제만 처리한다.
위험 확인은 3자 제공업체를 이용한다.



#### 결제 실행자
결제 실행자는 결제 서비스 공급자(psp) 를 통해 결제 주문을 하나 실행한다.
하나의 결제 이벤트에는 여거 결제 주문이 포함될 수 있다.


#### 결제 서비스 공급자

![pay-overview](/images/payment-system/pg-main.png)
PSP는 A 계정에서 B 계정으로 돈을 옮기는 역할을 담당..


#### 카드 유형
비자, 마스터카드, 디스커버리 등등...


#### 원장
원장(ledger) 결제 트랜잭션에 대한 금융 기록.
사용자가 판매자에게 1달러를 결제하면 사용자로부터 1달러를 인출하고
판매자에게 1달러를 지급하는 기록을 남김

#### 지갑
지갑에는 판매자의 계정 잔액을 기록.


### 결제 서비스 API

`POST /v1/payments`


| field            	| description    	| type   	|
|------------------	|-------------	    |--------	|
| seller           	| 대금을 수령할 판매자	 | string 	|
| amount           	| 주문 대금            | string 	|
| currency         	| 사용된 통화 단위       	| string 	|
| payment_order_id 	| 주문 식별 전역 고유 ID   	| string 	|


`payment_order_id` 는 전역적(globally)으로 고유한 값이다 
이 값은 중복제거 ID로 사용되며 멱등 키라고도 한다

`amount`의 경우 데이터 타입이 double이 아닌 string 임에 주의할것

프로토콜, 소프트웨어, 하드웨어에 따라 직렬/역직렬화 시에 의도치않게 값이 반올림 될 수 있고
숫자가 매우 클 수도, 매우 작을 수도 있어 string 으로 저장한다.



